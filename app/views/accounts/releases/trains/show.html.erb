<div class="sm:flex sm:justify-between sm:items-center mb-8">
  <!-- Left: Title -->
  <div class="mb-4 sm:mb-0">
    <% if @train.inactive? %>
      <h1 class="text-2xl md:text-3xl text-slate-800 font-bold">
        <%= @train.name %> ðŸš¦
        <div class="text-xs inline-flex font-medium bg-rose-100 text-rose-600 rounded-full text-center px-2.5 py-1">Inactive</div>
      </h1>
    <% else %>
      <h1 class="text-2xl md:text-3xl text-slate-800 font-bold"><%= @train.name %> ðŸš¦</h1>
    <% end %>
  </div>

  <% if @train.active? %>
    <div class="grid grid-flow-col sm:auto-cols-max justify-start sm:justify-end gap-2">
      <%= form_with(url: deactivate_accounts_organization_app_releases_train_path(current_organization, @app, @train),
                    method: :patch,
                    data: { turbo_confirm: 'Are you sure?' }) do |form| %>
        <div class="mt-5">
          <%= form.submit 'Deactivate train', class: "btn bg-rose-500 hover:bg-rose-600 text-white" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<div class="border-t border-slate-200">
  <div class="space-y-8 mt-8">
    <h2 class="text-2xl text-slate-800 font-bold mb-6">Train deets</h2>
    <table class="table-auto w-full">
      <!-- Table header -->
      <thead class="text-xs font-semibold uppercase text-slate-500 bg-slate-50 border-t border-b border-slate-200">
      <tr>
        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="font-semibold text-left">Description</div>
        </th>
        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="font-semibold text-left">Version originally started from</div>
        </th>
        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="font-semibold text-left">Version Suffix</div>
        </th>
        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="font-semibold text-left">Original Kickoff Date</div>
        </th>
        <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="font-semibold text-left">Repeats every</div>
        </th>
      </tr>
      </thead>
      <!-- Table body -->
      <tbody class="text-sm divide-y divide-slate-200">
      <!-- Row -->
      <tr>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="text-left"><%= @train.description %></div>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="text-left"><%= @train.version_seeded_with %></div>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="text-left">-<%= @train.version_suffix %></div>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="text-left"><%= @train.kickoff_at.strftime("%b %e, %l:%M %p") %></div>
        </td>
        <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
          <div class="text-left"><%= ActiveSupport::Duration.parse(Duration.new(@train.repeat_duration).iso8601).inspect %></div>
        </td>
      </tr>
      </tbody>
    </table>
    <% if @train.steps.size > 0 %>
      <h2 class="text-2xl text-slate-800 font-bold mb-6">Steps</h2>
      <p>
      <table class="table-auto w-full">
        <!-- Table header -->
        <thead class="text-xs font-semibold uppercase text-slate-500 bg-slate-50 border-t border-b border-slate-200">
        <tr>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">#</div>
          </th>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">Name</div>
          </th>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">Description</div>
          </th>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">Build Channel</div>
          </th>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">CI/CD Workflow</div>
          </th>
          <th class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
            <div class="font-semibold text-left">Run after previous step</div>
          </th>
        </tr>
        </thead>
        <!-- Table body -->
        <tbody class="text-sm divide-y divide-slate-200">
        <!-- Row -->
        <% @train.steps.order(:step_number).each do |step| %>
          <tr>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left"><%= step.step_number %></div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left"><%= step.name %></div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left"><%= step.description %></div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left"><%= step.build_artifact_channel %></div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left"><%= step.ci_cd_channel %></div>
            </td>
            <td class="px-2 first:pl-5 last:pr-5 py-3 whitespace-nowrap">
              <div class="text-left">
                <% after_previous_step = ActiveSupport::Duration.parse(Duration.new(step.run_after_duration).iso8601) %>
                <%= after_previous_step == 0.seconds ? "As soon as the train starts" : after_previous_step.inspect %>
              </div>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
      <div class="m-1.5">
        <button class="btn bg-indigo-500 hover:bg-indigo-600 text-white">
          <%= link_to "Add another step",
                      new_accounts_organization_app_releases_train_step_path(current_organization, @app, @train) %>
        </button>
      </div>
    <% else %>
      <% if @train.integrations_are_ready? %>
        <div class="m-1.5">
          <button class="btn bg-indigo-500 hover:bg-indigo-600 text-white">
            <%= link_to "Add a step",
                        new_accounts_organization_app_releases_train_step_path(current_organization, @app, @train) %>
          </button>
        </div>
      <% else %>
        <p>
          Complete your
          <%= link_to "notifiers",
                      accounts_organization_app_path(current_organization, @app) %>
          before adding a new step.
        </p>
      <% end %>
    <% end %>
    <ul class="-my-2">
      <!-- List item -->
      <h2 class="text-2xl text-slate-800 font-bold mb-6">Runs</h2>
      <% @train.runs.order(:was_run_at).each_with_index do |run, idx| %>
        <% color = run.on_track? ? "bg-indigo-500" : "bg-slate-800" %>
        <li class="relative py-2">
          <div class="flex items-center mb-1">
            <div class="absolute left-0 h-full w-0.5 bg-slate-200 self-start ml-2.5 -translate-x-1/2 translate-y-3" aria-hidden="true"></div>
            <div class="absolute left-0 rounded-full <%= color %>" aria-hidden="true">
              <svg class="w-5 h-5 fill-current text-white" viewBox="0 0 20 20">
                <path d="M14.4 8.4L13 7l-4 4-2-2-1.4 1.4L9 13.8z"/>
              </svg>
            </div>
            <h3 class="text-lg font-bold text-slate-800 pl-9">Release #<%= idx + 1 %></h3>
            <div class="text-xs ml-2 inline-flex font-medium bg-slate-100 text-slate-500 rounded-full text-center px-2.5 py-1">
              <%= run.was_run_at.strftime("%b %e, %l:%M %p") %>
            </div>
          </div>

          <div class="pl-9 flex">
            <%= image_tag("git-branch.svg") %>
            <code class="ml-1"><%= run.release_branch %></code>
          </div>
        </li>
      <% end %>
      <li class="relative py-2">
        <div class="flex items-center mb-1">
          <div class="absolute left-0 rounded-full bg-white" aria-hidden="true">
            <svg class="w-5 h-5 fill-current text-slate-400" viewBox="0 0 20 20">
              <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm0 2C4.477 20 0 15.523 0 10S4.477 0 10 0s10 4.477 10 10-4.477 10-10 10z"/>
            </svg>
          </div>
          <h3 class="text-lg font-bold text-slate-800 pl-9">Upcoming release</h3>
        </div>
        <div class="pl-9">On <%= @train.next_run_at.strftime("%b %e, %l:%M %p") %></div>
      </li>
    </ul>
  </div>
</div>



